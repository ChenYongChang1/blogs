## 代码调整相关章节

### 代码调整方法总结
如果还对代码调整能否有助于提高某个程序的性能心存疑虑，按照以下的步骤去做吧。      
1. 用设计良好的代码来开发软件，从而使程序易于理解和修改。
2. 如果程序性能很差。    
   a.保存代码的可运行版本，这样你才能回到“最近的已知正常状态”；          
   b.对系统进行分析测量，找出热点；          
   c.判断性能拙劣是否源于设计、数据类型或算法上的缺陷，确定是否应该做代码调整，如果不是，请跳回第一步；  
   d.对步骤c中的所确定的瓶颈代码进行调整；   
   e.每次调整后都对性能提升进行测量；  
   f.如果调整没有改进代码的性能，就恢复到步骤a保存的代码（通常而言，超过一半的调整尝试都只能稍微改善性能甚至造成性能恶化）。
3. 重复步骤2。

### 代码调整技术
1. 逻辑
2. 循环
3. 数据变换
4. 表达式
5. 子程序
6. 用低级语言重写代码
7. 变得越多，事情反而越没变

#### 逻辑
**在知道答案后停止判断**             
一些语言提供了所谓的“短路求值”的表达式求值形式，这就意味着编译器所产生的代码一旦知道了判断的结果就会自动停止继续判断
。短路求值是C++标准运算符功能的一部分，Java的“条件（conditional）”运算符也是这样。    
          
一旦知道答案就停止判断的原则同样适用于其他很多场合。一种常见的情况就是搜索循环。如果你在一个存放属兔数据的数组中
寻找负数，并且仅仅需要知道是否有负数存在，那么有一种办法使检查每一个值，在找到负数后将negativeFound变量设置为
真。下面就是这种搜索方法。         
```c++
//C++示例：在知道答案之后不停下
negativeInputFound = false;
for (i = 0; i < count; i++) {
   if (input[i] < 0) {
      negativeInputFound = true;
   }
}
```

更好的方式是在找到负值后就立即停止查找。下面的任何一种方案都可以解决问题。      
- 在```negativeInputFound = true;```之后添加一个```break```语句。
- 如果你使用的语言不支持```break```,那么就用goto跳转到循环体结束后的第一行语句，模拟```break```的行为。
- 将for循环改为while循环，然后每次除了像for循环检查循环计数是否超过count外，还要检查negativeInputFound的值。
- 将for循环改为改为while循环，在输入数组的最后一项之后第一个空位置设置一个哨兵值（sentinel value），
然后简单地在while测试中检测负值。在循环结束后，看看首先发现的值是在原数组的范围内还是在哨兵位置。    
             
**按照出现的频率来调整判断顺序**         
安排判断的顺序，让运行最快和判断结果最有可能为真的判断首先执行。也就是说，让程序更容易进入常见情况的处理，如果有低效率的
情况，那就应该出现在处理非常见的情况时。这样的原则适用于case语句以及if-then-else语句串。     
             
下面就是一个Select-Case语句它负责在字处理程序中对键盘输入进行响应：          
``` 
Visual Basic示例：顺序差劲的逻辑判断
Select inputCharacter
   Case "+", "="
      ProcessMathSymbol(inputCharacter)
   Case "0" To "9"
      ProcessDigit(inputCharacter)
   Case ",", ".", ":", ";", "!", "?"
      ProcessPunctuation(inputCharacter)
   Case " "
      ProcessSpace(inputCharacter)
   Case "A" To "Z", "a" To "z"
      ProcessAlpha(inputCharacter)
   Case Else
      ProcessError(inputCharacter)
End Select
```
如果你能知道输入字符的出现频率，就可以把最常见的情况放在最前面。
```
Visual Basic示例：顺序合理的逻辑判断
Select inputCharacter
   Case "A" To "Z", "a" To "z"
         ProcessAlpha(inputCharacter)
   Case " "
         ProcessSpace(inputCharacter)
   Case ",", ".", ":", ";", "!", "?"
         ProcessPunctuation(inputCharacter)
   Case "0" To "9"
         ProcessDigit(inputCharacter)
   Case "+", "="
      ProcessMathSymbol(inputCharacter)
   Case Else
      ProcessError(inputCharacter)
End Select
```
在优化后的代码中，由于最常见的情况通常会很快发现，直接效果就是更少的判断所带来的性能提升。            
| 语言        | 调整使用前   | 调整使用后   |  节省的时间 |   
| -   | :-:  | :-:  |  :-: |       
| C#     | 0.220 |   0.260     |   -18%  |  
| Java   | 2.56  |   2.56   |    0%    |                 
| Visual Basic |    0.280    |  0.260  |  %7  |               
               
| Name | Academy | score |   
| - | :-: | -: |   
| Harry Potter | Gryffindor| 90 |   
| Hermione Granger | Gryffindor | 100 |   
| Draco Malfoy | Slytherin | 90 | 
   
